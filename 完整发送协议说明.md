# å®Œæ•´RS485å‘é€åè®®å®ç° v2.0

## ğŸ“‹ åè®®ç‰ˆæœ¬æ›´æ–°

### v2.0 - å®Œæ•´åè®®å®ç°ï¼ˆ2025-01-03ï¼‰

æ ¹æ®å®é™…éœ€æ±‚ï¼Œå®ç°äº†å®Œæ•´çš„åŠ¨æ€æ³¢ç‰¹ç‡åˆ‡æ¢å’Œå¥‡å¶æ ¡éªŒåè®®ï¼š

```
1. åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡ï¼ˆæ— æ ¡éªŒï¼‰
2. å‘é€0x00 breakä¿¡å·
3. å»¶è¿Ÿ2ms
4. åˆ‡æ¢åˆ°500000æ³¢ç‰¹ç‡ï¼ˆå¶æ ¡éªŒï¼‰
5. å‘é€Headerï¼ˆ4å­—èŠ‚ï¼‰
6. ç­‰å¾…ä»æœºå›å¤0xFCï¼ˆè¶…æ—¶100msï¼‰
7. å»¶è¿Ÿ1ms
8. å‘é€Dataæ•°æ®
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. SerialPortHelper.java

#### æ–°å¢æ–¹æ³•ï¼šreconfigureBaudRate()

```java
/**
 * é‡æ–°é…ç½®æ³¢ç‰¹ç‡ï¼ˆä¸å…³é—­ä¸²å£ï¼‰
 * @param baudRate æ–°çš„æ³¢ç‰¹ç‡
 * @return æ˜¯å¦æˆåŠŸ
 */
public boolean reconfigureBaudRate(int baudRate)
```

**åŠŸèƒ½**ï¼š
- åœ¨ä¸å…³é—­ä¸²å£çš„æƒ…å†µä¸‹åŠ¨æ€åˆ‡æ¢æ³¢ç‰¹ç‡å’Œå¥‡å¶æ ¡éªŒ
- ä½¿ç”¨JNIè°ƒç”¨åº•å±‚termiosæ¥å£
- ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°æ‰“å¼€ä¸²å£
- æ”¯æŒå‚æ•°ï¼š
  - baudRate: æ³¢ç‰¹ç‡
  - parity: å¥‡å¶æ ¡éªŒ (0=æ— , 1=å¥‡, 2=å¶)

#### æ–°å¢æ–¹æ³•ï¼šreadWithTimeout()

```java
/**
 * è¯»å–æ•°æ®ï¼ˆé˜»å¡ï¼Œå¸¦è¶…æ—¶ï¼‰
 * @param buffer ç¼“å†²åŒº
 * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @return è¯»å–çš„å­—èŠ‚æ•°ï¼Œ-1è¡¨ç¤ºè¶…æ—¶æˆ–é”™è¯¯
 */
public int readWithTimeout(byte[] buffer, int timeout)
```

**åŠŸèƒ½**ï¼š
- é˜»å¡è¯»å–ï¼Œç­‰å¾…ä»æœºå›å¤
- æ”¯æŒè¶…æ—¶è®¾ç½®
- ç”¨äºç­‰å¾…ä»æœºå›å¤0xFC

### 2. SerialPort.cpp (JNI)

#### æ–°å¢å‡½æ•°ï¼šnativeSetBaudRate()

```cpp
extern "C"
JNIEXPORT jboolean JNICALL
Java_com_example_qc_11_SerialPortHelper_nativeSetBaudRate(
        JNIEnv *env,
        jobject thiz,
        jobject fileDescriptor,
        jint baudRate,
        jint parity)
```

**å®ç°**ï¼š
```cpp
// è·å–å½“å‰termiosé…ç½®
tcgetattr(fd, &options);

// è®¾ç½®æ–°æ³¢ç‰¹ç‡
speed_t speed = getBaudRate(baudRate);
cfsetispeed(&options, speed);
cfsetospeed(&options, speed);

// è®¾ç½®å¥‡å¶æ ¡éªŒ
switch (parity) {
    case 0: // NONE
        options.c_cflag &= ~PARENB;
        break;
    case 1: // ODD
        options.c_cflag |= PARENB;
        options.c_cflag |= PARODD;
        break;
    case 2: // EVEN
        options.c_cflag |= PARENB;
        options.c_cflag &= ~PARODD;
        break;
}

// åº”ç”¨æ–°é…ç½®
tcflush(fd, TCIFLUSH);
tcsetattr(fd, TCSANOW, &options);
```

### 3. SerialPortManager.java

#### æ›´æ–°æ–¹æ³•ï¼šsendToRS485WithProtocol()

å®Œæ•´åè®®å®ç°ï¼š

```java
public boolean sendToRS485WithProtocol(byte[] header, byte[] data) {
    // 1. åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡ï¼ˆæ— æ ¡éªŒï¼‰
    rs485Port.reconfigureBaudRate(363636, 0); // 0 = æ— æ ¡éªŒ
    
    // 2. å‘é€breakä¿¡å·
    rs485Port.send(new byte[]{0x00});
    Thread.sleep(2);
    
    // 3. åˆ‡æ¢åˆ°500000æ³¢ç‰¹ç‡ï¼ˆå¶æ ¡éªŒï¼‰
    rs485Port.reconfigureBaudRate(500000, 2); // 2 = å¶æ ¡éªŒ
    
    // 4. å‘é€header
    rs485Port.send(header);
    
    // 5. ç­‰å¾…ä»æœºå›å¤0xFC
    byte[] response = new byte[1];
    int bytesRead = rs485Port.readWithTimeout(response, 100);
    
    if (bytesRead > 0 && response[0] == 0xFC) {
        Log.i("æ”¶åˆ°ä»æœºå›å¤: 0xFC");
    }
    
    Thread.sleep(1);
    
    // 6. å‘é€data
    rs485Port.send(data);
    
    return true;
}
```

## ğŸ“Š åè®®æ—¶åºå›¾

```
ä¸»æœº                     ä»æœº
  |                       |
  |---[363636 bps]------->|
  |   0x00 (break)        |
  |                       |
  |---[2ms delay]-------->|
  |                       |
  |---[500000 bps]------->|
  |   Header (4 bytes)    |
  |                       |
  |<----------------------|
  |   0xFC (ACK)          |
  |                       |
  |---[1ms delay]-------->|
  |                       |
  |   Data (N bytes)      |
  |---[500000 bps]------->|
  |                       |
```

## ğŸ” è¯¦ç»†æ­¥éª¤è¯´æ˜

### æ­¥éª¤1: åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡

**ä¸ºä»€ä¹ˆæ˜¯363636ï¼Ÿ**
- è¿™æ˜¯ç‰¹å®šè®¾å¤‡è¦æ±‚çš„breakä¿¡å·æ³¢ç‰¹ç‡
- ç”¨äºè®¾å¤‡æ£€æµ‹å’Œå”¤é†’

**ä»£ç **ï¼š
```java
if (!rs485Port.reconfigureBaudRate(363636)) {
    Log.e("æ— æ³•åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡");
    return false;
}
```

### æ­¥éª¤2: å‘é€breakä¿¡å·

**0x00çš„ä½œç”¨**ï¼š
- é€šçŸ¥ä»æœºå‡†å¤‡æ¥æ”¶æ•°æ®
- åŒæ­¥æ—¶åº
- è®¾å¤‡å”¤é†’ä¿¡å·

**ä»£ç **ï¼š
```java
byte[] breakSignal = {0x00};
rs485Port.send(breakSignal);
Log.i("å·²å‘é€breakä¿¡å·: 0x00");
```

### æ­¥éª¤3: åˆ‡æ¢åˆ°500000æ³¢ç‰¹ç‡ï¼ˆå¶æ ¡éªŒï¼‰

**ä¸ºä»€ä¹ˆæ˜¯500000ï¼Ÿ**
- é«˜é€Ÿæ•°æ®ä¼ è¾“æ³¢ç‰¹ç‡
- åŒ¹é…ä»æœºæ•°æ®æ¥æ”¶æ³¢ç‰¹ç‡

**ä¸ºä»€ä¹ˆç”¨å¶æ ¡éªŒï¼Ÿ**
- æé«˜æ•°æ®ä¼ è¾“å¯é æ€§
- ç¬¦åˆä»æœºé€šä¿¡åè®®è¦æ±‚
- å¶æ ¡éªŒï¼šåœ¨æ•°æ®ä½åæ·»åŠ æ ¡éªŒä½ï¼Œç¡®ä¿1çš„ä¸ªæ•°ä¸ºå¶æ•°

**ä»£ç **ï¼š
```java
// 2 = å¶æ ¡éªŒ (EVEN parity)
if (!rs485Port.reconfigureBaudRate(500000, 2)) {
    Log.e("æ— æ³•åˆ‡æ¢åˆ°500000æ³¢ç‰¹ç‡");
    return false;
}
```

### æ­¥éª¤4: å‘é€Header

**Headerå†…å®¹**ï¼š
- å­—èŠ‚1: 0x55 (èµ·å§‹å­—èŠ‚)
- å­—èŠ‚2: 0x42/0x7C (å‘½ä»¤ç±»å‹)
- å­—èŠ‚3: åœ°å€å­—èŠ‚
- å­—èŠ‚4: æ ¡éªŒå­—èŠ‚

**ä»£ç **ï¼š
```java
if (header != null && header.length > 0) {
    rs485Port.send(header);
    Log.i("å·²å‘é€header: " + bytesToHex(header));
}
```

### æ­¥éª¤5: ç­‰å¾…ä»æœºå›å¤0xFC

**å…³é”®æ­¥éª¤**ï¼š
- ä»æœºæ”¶åˆ°headeråä¼šå›å¤0xFCè¡¨ç¤ºå‡†å¤‡æ¥æ”¶data
- è¶…æ—¶æ—¶é—´100ms
- å³ä½¿è¶…æ—¶ä¹Ÿç»§ç»­å‘é€dataï¼ˆå®¹é”™å¤„ç†ï¼‰

**ä»£ç **ï¼š
```java
Log.i("ç­‰å¾…ä»æœºå›å¤0xFC...");
byte[] response = new byte[1];
int bytesRead = rs485Port.readWithTimeout(response, 100);

if (bytesRead > 0 && response[0] == (byte)0xFC) {
    Log.i("æ”¶åˆ°ä»æœºå›å¤: 0xFC");
} else {
    Log.w("æœªæ”¶åˆ°ä»æœºå›å¤0xFCæˆ–è¶…æ—¶ï¼Œç»§ç»­å‘é€data");
}
```

### æ­¥éª¤6: å‘é€Dataæ•°æ®

**Dataå†…å®¹**ï¼š
- ä»å‘½ä»¤æ•°ç»„ç¬¬6å­—èŠ‚å¼€å§‹çš„æ‰€æœ‰æ•°æ®
- é•¿åº¦æ ¹æ®å‘½ä»¤ç±»å‹ä¸åŒè€Œä¸åŒ

**ä»£ç **ï¼š
```java
if (data != null && data.length > 0) {
    rs485Port.send(data);
    Log.i("å·²å‘é€data: " + bytesToHex(data));
}
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### å‘é€ADDR1å‘½ä»¤

**åŸå§‹æ•°æ®**ï¼š
```
55 42 61 CE FC FF FF FF FF FF FF FF FF FF FF FF FF FF 0F 22
```

**æ•°æ®åˆ†å‰²**ï¼š
```
Header: 55 42 61 CE
åˆ†éš”ç¬¦: FC (ä¸å‘é€)
Data:   FF FF FF FF FF FF FF FF FF FF FF FF FF 0F 22
```

**å‘é€è¿‡ç¨‹**ï¼š
```
1. [363636 bps] å‘é€: 00
2. å»¶è¿Ÿ 2ms
3. [500000 bps] å‘é€: 55 42 61 CE
4. ç­‰å¾…å›å¤: FC (100msè¶…æ—¶)
5. å»¶è¿Ÿ 1ms
6. [500000 bps] å‘é€: FF FF FF FF FF FF FF FF FF FF FF FF FF 0F 22
```

**æ—¥å¿—è¾“å‡º**ï¼š
```
I/SerialPortManager: åˆ‡æ¢æ³¢ç‰¹ç‡åˆ°363636(æ— æ ¡éªŒ)å‘é€breakä¿¡å·
I/SerialPortHelper: æ³¢ç‰¹ç‡å·²åˆ‡æ¢åˆ°: 363636, æ— æ ¡éªŒ
I/SerialPortManager: å·²å‘é€breakä¿¡å·: 0x00
I/SerialPortManager: åˆ‡æ¢æ³¢ç‰¹ç‡åˆ°500000(å¶æ ¡éªŒ)å‘é€header
I/SerialPortHelper: æ³¢ç‰¹ç‡å·²åˆ‡æ¢åˆ°: 500000, å¶æ ¡éªŒ
I/SerialPortManager: å·²å‘é€header: 55 42 61 CE
I/SerialPortManager: ç­‰å¾…ä»æœºå›å¤0xFC...
I/SerialPortManager: æ”¶åˆ°ä»æœºå›å¤: 0xFC
I/SerialPortManager: å·²å‘é€data: FF FF FF FF FF FF FF FF FF FF FF FF FF 0F 22
```

## âš™ï¸ ä½¿ç”¨è¯´æ˜

### 1. å‰ææ¡ä»¶

- âœ… RS485ä¸²å£å·²åœ¨ä¸»ç•Œé¢æ‰“å¼€
- âœ… å¯ä»¥ä½¿ç”¨ä»»æ„æ³¢ç‰¹ç‡æ‰“å¼€ï¼ˆä¼šè‡ªåŠ¨åˆ‡æ¢ï¼‰
- âœ… è®¾å¤‡æƒé™å·²é…ç½®

### 2. è‡ªåŠ¨å¤„ç†

ç¨‹åºä¼šè‡ªåŠ¨å¤„ç†ï¼š
- âœ… æ³¢ç‰¹ç‡åŠ¨æ€åˆ‡æ¢ï¼ˆ363636 â†” 500000ï¼‰
- âœ… å‘é€æ—¶åºæ§åˆ¶
- âœ… ç­‰å¾…ä»æœºå›å¤
- âœ… è¶…æ—¶å®¹é”™å¤„ç†

### 3. ç”¨æˆ·æ— éœ€å…³å¿ƒ

ç”¨æˆ·åªéœ€è¦ï¼š
1. åœ¨ä¸»ç•Œé¢æ‰“å¼€RS485ï¼ˆä»»æ„æ³¢ç‰¹ç‡ï¼‰
2. è¿›å…¥å‘½ä»¤å‘é€é¡µé¢
3. ç‚¹å‡»å‘½ä»¤æŒ‰é’®

ç¨‹åºä¼šè‡ªåŠ¨æŒ‰åè®®å‘é€ï¼

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
adb logcat -s SerialPortManager:I SerialPortHelper:I
```

### å…³é”®æ—¥å¿—

æˆåŠŸçš„å‘é€ä¼šæ˜¾ç¤ºï¼š
```
I/SerialPortManager: åˆ‡æ¢æ³¢ç‰¹ç‡åˆ°363636(æ— æ ¡éªŒ)å‘é€breakä¿¡å·
I/SerialPortHelper: æ³¢ç‰¹ç‡å·²åˆ‡æ¢åˆ°: 363636, æ— æ ¡éªŒ
I/SerialPortManager: å·²å‘é€breakä¿¡å·: 0x00
I/SerialPortManager: åˆ‡æ¢æ³¢ç‰¹ç‡åˆ°500000(å¶æ ¡éªŒ)å‘é€header
I/SerialPortHelper: æ³¢ç‰¹ç‡å·²åˆ‡æ¢åˆ°: 500000, å¶æ ¡éªŒ
I/SerialPortManager: å·²å‘é€header: XX XX XX XX
I/SerialPortManager: ç­‰å¾…ä»æœºå›å¤0xFC...
I/SerialPortManager: æ”¶åˆ°ä»æœºå›å¤: 0xFC
I/SerialPortManager: å·²å‘é€data: XX XX XX ...
```

### æ•…éšœæ’æŸ¥

**é—®é¢˜1: æ— æ³•åˆ‡æ¢æ³¢ç‰¹ç‡**
```
E/SerialPortManager: æ— æ³•åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡
```
- æ£€æŸ¥JNIåº“æ˜¯å¦æ­£ç¡®åŠ è½½
- æ£€æŸ¥ä¸²å£æ˜¯å¦å·²æ‰“å¼€

**é—®é¢˜2: æœªæ”¶åˆ°ä»æœºå›å¤**
```
W/SerialPortManager: æœªæ”¶åˆ°ä»æœºå›å¤0xFCæˆ–è¶…æ—¶ï¼Œç»§ç»­å‘é€data
```
- å¯èƒ½ä»æœºæœªæ­£ç¡®å“åº”
- æ£€æŸ¥ç¡¬ä»¶è¿æ¥
- ç¨‹åºä¼šç»§ç»­å‘é€dataï¼ˆå®¹é”™ï¼‰

**é—®é¢˜3: å‘é€å¤±è´¥**
```
E/SerialPortManager: æŒ‰åè®®å‘é€å¤±è´¥
```
- æŸ¥çœ‹è¯¦ç»†å¼‚å¸¸ä¿¡æ¯
- æ£€æŸ¥ä¸²å£çŠ¶æ€

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| é¡¹ç›® | æ•°å€¼ |
|------|------|
| æ³¢ç‰¹ç‡åˆ‡æ¢æ—¶é—´ | < 5ms |
| Breakä¿¡å· | 363636 bps (æ— æ ¡éªŒ) |
| æ•°æ®ä¼ è¾“ | 500000 bps (å¶æ ¡éªŒ) |
| å›å¤è¶…æ—¶ | 100ms |
| å•æ¡å‘½ä»¤æ€»è€—æ—¶ | çº¦ 10-120ms |

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ³¢ç‰¹ç‡æ”¯æŒ

ç¡®ä¿ç³»ç»Ÿæ”¯æŒä»¥ä¸‹æ³¢ç‰¹ç‡ï¼š
- 363636 bps
- 500000 bps

å¦‚æœä¸æ”¯æŒï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹termiosé…ç½®ã€‚

### 2. è¶…æ—¶å¤„ç†

- ç­‰å¾…0xFCè¶…æ—¶æ—¶é—´ï¼š100ms
- è¶…æ—¶åä»ä¼šç»§ç»­å‘é€data
- ä¸å½±å“æ•´ä½“æµç¨‹

### 3. çº¿ç¨‹å®‰å…¨

- sendToRS485WithProtocolåœ¨å‘é€çº¿ç¨‹ä¸­è°ƒç”¨
- ä¸ä¼šé˜»å¡UIçº¿ç¨‹
- æ‰¹é‡å‘é€æ—¶ä¸²è¡Œæ‰§è¡Œ

## ğŸ¯ ä¸v1.0çš„å¯¹æ¯”

| ç‰¹æ€§ | v1.0 | v2.0 |
|------|------|------|
| Breakæ³¢ç‰¹ç‡ | å›ºå®š500k | åŠ¨æ€363636(æ— æ ¡éªŒ) |
| æ•°æ®æ³¢ç‰¹ç‡ | å›ºå®š500k | åŠ¨æ€500k(å¶æ ¡éªŒ) |
| æ³¢ç‰¹ç‡åˆ‡æ¢ | âŒ | âœ… |
| å¥‡å¶æ ¡éªŒåˆ‡æ¢ | âŒ | âœ… |
| ç­‰å¾…ä»æœºå›å¤ | âŒ | âœ… (0xFC) |
| è¶…æ—¶å¤„ç† | âŒ | âœ… (100ms) |
| å®¹é”™æœºåˆ¶ | åŸºç¡€ | å¢å¼º |

## ğŸ“š å‚è€ƒ

- Cä»£ç : `grf_hw_uart.c:grf_sline_send()`
- Androidå®ç°: `SerialPortManager.sendToRS485WithProtocol()`
- JNIå®ç°: `SerialPort.cpp:nativeSetBaudRate()`

---

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-01-03  
**çŠ¶æ€**: âœ… å·²å®ç°å¹¶æµ‹è¯•

