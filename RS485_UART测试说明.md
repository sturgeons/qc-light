# RS485和UART串口测试程序使用说明

## 项目概述
这是一个Android串口通信测试程序，用于测试TSB设备的RS485和UART串口数据接收功能。

## 设备节点映射

| 设备 | 设备节点 |
|------|---------|
| RS485 | /dev/ttyS2 |
| UART | /dev/ttyUSB0 |

## 功能特性

### 1. RS485串口测试 (/dev/ttyS2)
- ✅ 可调整波特率：1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 230400, 460800
- ✅ 实时数据接收显示
- ✅ HEX和ASCII格式显示
- ✅ 带时间戳的数据记录
- ✅ 连接状态指示
- ✅ 清空数据缓冲区

### 2. UART串口测试 (/dev/ttyUSB0)
- ✅ 可调整波特率：1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 230400, 460800
- ✅ 实时数据接收显示
- ✅ HEX和ASCII格式显示
- ✅ 带时间戳的数据记录
- ✅ 连接状态指示
- ✅ 清空数据缓冲区

## 使用步骤

### 1. 打开串口
1. 选择所需的波特率（默认9600）
2. 点击"打开"按钮
3. 观察状态指示，显示"已连接"表示成功

### 2. 接收数据
- 数据会自动显示在相应的文本区域
- 每条数据包含时间戳
- 同时显示HEX格式和ASCII格式
- 数据区会自动滚动到最新内容

### 3. 关闭串口
- 点击"关闭"按钮停止接收数据

### 4. 清空显示
- 点击"清空"按钮清除显示区域的内容

## 技术实现

### 架构
```
MainActivity.java          - 主界面，用户交互
    ↓
SerialPortManager.java    - 串口管理，处理RS485和UART
    ↓
SerialPortHelper.java     - 串口通信封装
    ↓
SerialPort.cpp (JNI)      - 底层Linux串口操作
```

### JNI本地实现
- 使用C++实现底层串口通信
- 基于Linux termios接口
- 支持完整的串口参数配置
  - 波特率：1200 ~ 460800
  - 数据位：8位
  - 停止位：1位
  - 校验位：无

### 数据格式
接收到的数据以两种格式显示：
```
[14:30:25.123] HEX: 48 65 6C 6C 6F
ASCII: Hello
```

## 权限要求

程序已在AndroidManifest.xml中声明以下权限：
- `READ_EXTERNAL_STORAGE`
- `WRITE_EXTERNAL_STORAGE`

## 编译环境

### 要求
- Android Studio 2023.1+
- Android SDK API 24+
- NDK 25.1+
- CMake 3.22.1+

### 编译步骤
1. 打开Android Studio
2. 导入项目
3. 等待Gradle同步完成
4. 点击"Run"或按Shift+F10编译并运行

### NDK支持的架构
- armeabi-v7a
- arm64-v8a
- x86
- x86_64

## 注意事项

### 1. 设备权限
在某些Android设备上，访问串口设备可能需要root权限。如果打开失败，请检查：
- 设备文件是否存在（/dev/ttyS2, /dev/ttyUSB0）
- 应用是否有权限访问设备文件
- 设备文件权限（可能需要通过adb shell chmod设置）

### 2. 设备文件检查
通过adb shell检查设备：
```bash
adb shell
ls -l /dev/ttyS*
ls -l /dev/ttyUSB*
```

### 3. 设置权限（如需要）
```bash
adb shell
su
chmod 666 /dev/ttyS2
chmod 666 /dev/ttyUSB0
```

### 4. 波特率设置
- RS485的波特率根据实际设备要求调整
- 建议先使用9600进行测试
- 确保发送端和接收端波特率一致

### 5. 数据流向
- 本程序主要用于接收数据
- 如需发送数据，SerialPortManager已提供sendToRS485()和sendToUart()方法

## 测试方法

### 1. RS485测试
连接RS485设备到/dev/ttyS2，发送测试数据，观察界面显示。

### 2. UART测试
连接UART设备到/dev/ttyUSB0，发送测试数据，观察界面显示。

### 3. 环回测试
如果设备支持，可以将TX和RX短接进行环回测试。

## 故障排查

### 问题1：无法打开串口
**可能原因：**
- 设备文件不存在
- 权限不足
- 设备已被其他应用占用

**解决方法：**
1. 检查设备文件是否存在
2. 使用su权限修改设备文件权限
3. 关闭其他可能占用串口的应用

### 问题2：接收不到数据
**可能原因：**
- 波特率不匹配
- 连接线路问题
- 发送端未发送数据

**解决方法：**
1. 检查波特率设置
2. 检查硬件连接
3. 使用示波器或逻辑分析仪检查信号

### 问题3：数据乱码
**可能原因：**
- 波特率不匹配
- 数据格式不匹配

**解决方法：**
1. 调整波特率直至数据正常
2. 检查数据位、停止位、校验位设置（当前固定为8N1）

## 扩展功能

如需添加其他功能，可以修改以下部分：

### 1. 添加数据发送功能
在MainActivity中添加输入框和发送按钮，调用：
```java
serialPortManager.sendToRS485(data);
serialPortManager.sendToUart(data);
```

### 2. 修改串口参数
在SerialPort.cpp的nativeOpen函数中修改：
- 数据位（dataBits）
- 停止位（stopBits）
- 校验位（parity）

### 3. 添加数据保存功能
可以将接收到的数据保存到文件，便于后续分析。

## 版本信息
- 版本：1.0
- 更新日期：2024-10-16
- 作者：自动生成

## 许可证
本项目仅供测试使用。

