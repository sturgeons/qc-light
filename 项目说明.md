# RS485/UART串口测试程序 - 项目说明

## 📋 项目概述

这是一个专为TSB安装系统设备开发的Android串口通信测试程序，用于测试RS485和UART串口的数据接收功能。

### 支持的设备节点

| 设备 | 设备节点 | 说明 |
|------|---------|------|
| RS485 | /dev/ttyS2 | 支持可调波特率 |
| UART | /dev/ttyUSB0 | 支持可调波特率 |

## 🎯 主要功能

### ✅ 已实现功能

1. **双串口同时支持**
   - RS485 (/dev/ttyS2)
   - UART (/dev/ttyUSB0)

2. **灵活的波特率配置**
   - 支持10种波特率：1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 230400, 460800
   - RS485和UART可独立设置波特率

3. **数据显示**
   - HEX格式显示
   - ASCII格式显示
   - 带时间戳（精确到毫秒）
   - 自动滚动到最新数据

4. **用户友好界面**
   - 独立的RS485和UART控制区域
   - 实时连接状态指示（颜色标识）
   - 一键清空数据缓冲区
   - 波特率下拉选择

5. **稳定性保证**
   - 独立线程处理数据接收
   - 异常处理机制
   - 资源自动释放

## 📁 项目结构

```
qc_1/
├── app/
│   ├── src/
│   │   ├── main/
│   │   │   ├── cpp/                          # JNI本地代码
│   │   │   │   ├── SerialPort.cpp           # 串口底层实现
│   │   │   │   └── CMakeLists.txt           # CMake配置
│   │   │   ├── java/com/example/qc_1/
│   │   │   │   ├── MainActivity.java        # 主界面Activity
│   │   │   │   ├── SerialPortHelper.java    # 串口通信辅助类
│   │   │   │   └── SerialPortManager.java   # 串口管理类
│   │   │   ├── res/
│   │   │   │   └── layout/
│   │   │   │       └── activity_main.xml    # 主界面布局
│   │   │   └── AndroidManifest.xml          # 应用配置文件
│   │   └── build.gradle.kts                 # 模块构建配置
│   └── build.gradle.kts                      # 应用构建配置
├── RS485_UART测试说明.md                      # 详细使用说明
├── 测试前准备.md                              # 测试准备工作
├── 项目说明.md                                # 本文件
├── 构建安装.bat                               # 自动构建安装脚本
├── 查看日志.bat                               # 日志查看工具
├── 设置串口权限.bat                           # 权限设置工具
└── 检查设备.bat                               # 设备检查工具
```

## 🔧 技术架构

### 架构层次

```
┌─────────────────────────────────────┐
│        MainActivity.java            │  <- UI层（用户交互）
├─────────────────────────────────────┤
│     SerialPortManager.java          │  <- 业务逻辑层
├─────────────────────────────────────┤
│     SerialPortHelper.java           │  <- 串口封装层
├─────────────────────────────────────┤
│     SerialPort.cpp (JNI)            │  <- 本地实现层
├─────────────────────────────────────┤
│     Linux termios API               │  <- 系统调用层
└─────────────────────────────────────┘
```

### 技术栈

- **开发语言**: Java (Android), C++ (JNI)
- **构建工具**: Gradle 8.x, CMake 3.22.1
- **NDK**: Android NDK 25+
- **最低Android版本**: API 24 (Android 7.0)
- **目标Android版本**: API 35
- **架构支持**: armeabi-v7a, arm64-v8a, x86, x86_64

### 关键技术点

1. **JNI串口通信**
   - 使用Linux termios库进行底层串口操作
   - 支持完整的串口参数配置
   - 异步数据读取

2. **多线程处理**
   - 独立线程处理串口数据接收
   - Handler机制更新UI
   - 线程安全的数据传递

3. **内存管理**
   - 正确释放JNI资源
   - 避免内存泄漏
   - 及时关闭文件描述符

## 🚀 快速开始

### 1. 编译和安装

**方法一：使用自动脚本（推荐）**
```bash
双击运行: 构建安装.bat
```

**方法二：使用命令行**
```bash
.\gradlew.bat assembleDebug
adb install -r app\build\outputs\apk\debug\app-debug.apk
```

### 2. 设置设备权限

```bash
双击运行: 设置串口权限.bat
```

或手动执行：
```bash
adb shell
su
chmod 666 /dev/ttyS2
chmod 666 /dev/ttyUSB0
```

### 3. 运行应用

```bash
adb shell am start -n com.example.qc_1/.MainActivity
```

### 4. 查看日志

```bash
双击运行: 查看日志.bat
```

## 📖 使用指南

### 基本操作流程

1. **打开串口**
   - 选择波特率（建议从9600开始）
   - 点击"打开"按钮
   - 等待状态显示为"已连接"（绿色）

2. **接收数据**
   - 数据自动显示在相应区域
   - 同时显示HEX和ASCII格式
   - 每条数据带时间戳

3. **关闭串口**
   - 点击"关闭"按钮
   - 状态变为"未连接"（灰色）

4. **清空显示**
   - 点击"清空"按钮清除显示区域

### 数据格式示例

```
[14:30:25.123] HEX: 48 65 6C 6C 6F 20 52 53 34 38 35
ASCII: Hello RS485

[14:30:26.456] HEX: 54 65 73 74 20 44 61 74 61
ASCII: Test Data
```

## 🛠️ 实用工具脚本

| 脚本名称 | 功能说明 |
|---------|---------|
| `构建安装.bat` | 自动编译、安装应用，可选启动和查看日志 |
| `查看日志.bat` | 实时查看应用日志，过滤串口相关信息 |
| `设置串口权限.bat` | 自动设置串口设备权限（需要root） |
| `检查设备.bat` | 检查设备连接、串口设备状态、应用安装情况 |

## ⚙️ 配置说明

### 修改设备路径

如果您的设备节点不同，可以在 `SerialPortManager.java` 中修改：

```java
public static final String RS485_DEVICE = "/dev/ttyS2";  // 修改为您的RS485设备路径
public static final String UART_DEVICE = "/dev/ttyUSB0"; // 修改为您的UART设备路径
```

### 修改串口参数

如需修改数据位、停止位、校验位，请编辑 `SerialPort.cpp` 中的 `nativeOpen` 函数。

当前配置：
- 数据位：8
- 停止位：1
- 校验位：无（N）
- 配置：8N1

## 🔍 故障排查

### 常见问题

| 问题 | 可能原因 | 解决方法 |
|------|---------|---------|
| 无法打开串口 | 设备文件不存在 | 运行`检查设备.bat`检查设备 |
| 权限被拒绝 | 没有访问权限 | 运行`设置串口权限.bat` |
| 接收不到数据 | 波特率不匹配 | 调整波特率设置 |
| 数据乱码 | 波特率或参数不匹配 | 检查发送端配置 |
| 应用崩溃 | JNI库加载失败 | 检查NDK配置和so库 |

### 调试步骤

1. **检查设备连接**
   ```bash
   双击运行: 检查设备.bat
   ```

2. **查看详细日志**
   ```bash
   双击运行: 查看日志.bat
   ```

3. **验证设备文件**
   ```bash
   adb shell ls -l /dev/ttyS2
   adb shell ls -l /dev/ttyUSB0
   ```

## 📊 性能指标

- **最大波特率**: 460800 bps
- **数据接收缓冲**: 1024 bytes
- **延迟**: < 100ms (从接收到显示)
- **支持的最大数据率**: 约 46 KB/s (在460800 bps下)

## 🔐 权限要求

应用需要以下权限：
- `READ_EXTERNAL_STORAGE` - 读取外部存储
- `WRITE_EXTERNAL_STORAGE` - 写入外部存储

**注意**: 在Android 6.0+设备上，某些串口访问可能需要root权限。

## 📝 开发说明

### 添加新功能

#### 1. 添加数据发送功能

在 `MainActivity.java` 中添加：
```java
String data = "Test Message";
byte[] bytes = data.getBytes();
serialPortManager.sendToRS485(bytes);  // 发送到RS485
serialPortManager.sendToUart(bytes);   // 发送到UART
```

#### 2. 添加更多串口设备

1. 在 `SerialPortManager.java` 中添加设备常量
2. 创建新的 `SerialPortHelper` 实例
3. 在UI中添加相应控件

#### 3. 修改数据显示格式

在 `SerialPortManager.java` 的数据回调中修改数据格式化方式。

### 编译注意事项

- 确保安装了NDK和CMake
- 首次编译可能需要下载依赖，请耐心等待
- 如果CMake版本不匹配，请修改 `CMakeLists.txt` 中的版本号

## 📚 参考文档

- [测试前准备.md](测试前准备.md) - 详细的测试准备步骤
- [RS485_UART测试说明.md](RS485_UART测试说明.md) - 完整的功能说明和使用教程

## 🐛 已知问题

1. 在某些设备上，频繁开关串口可能导致设备文件暂时不可用，建议等待1-2秒后重试
2. 高波特率下(> 115200)，部分设备可能出现数据丢失，建议先测试低波特率
3. 某些Android设备的USB转串口芯片驱动可能不完整，影响UART功能

## 📅 版本历史

### v1.0 (2024-10-16)
- ✅ 初始版本发布
- ✅ 支持RS485和UART双串口
- ✅ 可调波特率
- ✅ HEX和ASCII显示
- ✅ 实时数据接收
- ✅ 完整的JNI实现
- ✅ 实用工具脚本集

## 📧 技术支持

如有问题，请检查以下文件：
1. `RS485_UART测试说明.md` - 详细使用说明
2. `测试前准备.md` - 准备工作和常见问题
3. 运行 `查看日志.bat` 查看实时日志

## 📄 许可证

本项目仅供测试和学习使用。

---

**祝您测试顺利！** 🎉

