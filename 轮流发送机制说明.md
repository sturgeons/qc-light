# è½®æµå‘é€æœºåˆ¶è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å¼€å…³æ§åˆ¶é¡µé¢ v2.0 å®ç°äº†**è½®æµäº¤æ›¿å‘é€**æœºåˆ¶ï¼Œå¤šä¸ªå¼€å…³åŒæ—¶è¿è¡Œæ—¶ï¼Œå‘½ä»¤ä¼šæŒ‰ç…§åŠ å…¥é˜Ÿåˆ—çš„é¡ºåºè½®æµå‘é€ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¼€å…³å‘å®Œå†å‘å¦ä¸€ä¸ªã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

### ç”¨æˆ·éœ€æ±‚
- å¤šä¸ªå¼€å…³åŒæ—¶å¼€å¯æ—¶ï¼Œå¸Œæœ›çœ‹åˆ°**äº¤æ›¿å‘é€**çš„æ•ˆæœ
- æ¯ä¸ªå¼€å…³éƒ½èƒ½**å…¬å¹³åœ°**è·å¾—å‘é€æœºä¼š
- ä¸å¸Œæœ›ä¸€ä¸ªå¼€å…³"ç‹¬å "ä¸²å£ï¼Œå¯¼è‡´å…¶ä»–å¼€å…³é•¿æ—¶é—´ç­‰å¾…

### æŠ€æœ¯ç›®æ ‡
- âœ… å®ç°çœŸæ­£çš„è½®æµå‘é€
- âœ… ä¿è¯å‘é€åè®®çš„å®Œæ•´æ€§ï¼ˆä¸è¢«æ‰“æ–­ï¼‰
- âœ… å…¬å¹³è°ƒåº¦ï¼ˆFIFOå…ˆè¿›å…ˆå‡ºï¼‰
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆé¿å…æ•°æ®æ··ä¹±ï¼‰

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SwitchControlActivity                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¼€å…³1çº¿ç¨‹                å¼€å…³2çº¿ç¨‹                å¼€å…³3çº¿ç¨‹  â”‚
â”‚     â”‚                       â”‚                       â”‚        â”‚
â”‚     â”œâ”€ addCommand(1, ...)  â”œâ”€ addCommand(2, ...)  â”‚        â”‚
â”‚     â”œâ”€ addCommand(1, ...)  â”œâ”€ addCommand(2, ...)  â”‚        â”‚
â”‚     â”‚                       â”‚                       â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚         â”‚ SendQueueMgr  â”‚                                   â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                   â”‚
â”‚         â”‚ FIFO Queue    â”‚                                   â”‚
â”‚         â”‚ [C1][C2][C1]  â”‚                                   â”‚
â”‚         â”‚ [C2][C3][C1]  â”‚                                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚         â”‚ Send Thread   â”‚                                   â”‚
â”‚         â”‚ (single)      â”‚                                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚SerialPortMgr  â”‚
          â”‚(synchronized) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
              RS485ä¸²å£
                  â”‚
                  â–¼
                ä»æœº
```

### ä¸‰å±‚è®¾è®¡

#### ç¬¬ä¸€å±‚ï¼šç”Ÿäº§è€…ï¼ˆå„å¼€å…³çº¿ç¨‹ï¼‰
- **èŒè´£**ï¼šç”Ÿæˆå‘½ä»¤ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—
- **ç‰¹ç‚¹**ï¼šå¹¶å‘è¿è¡Œï¼Œäº’ä¸é˜»å¡
- **æ“ä½œ**ï¼š`sendQueueManager.addCommand(groupId, header, data)`

#### ç¬¬äºŒå±‚ï¼šé˜Ÿåˆ—ï¼ˆSendQueueManagerï¼‰
- **èŒè´£**ï¼šç¼“å­˜å‘½ä»¤ï¼ŒFIFOé¡ºåº
- **ç‰¹ç‚¹**ï¼šçº¿ç¨‹å®‰å…¨ï¼ˆBlockingQueueï¼‰
- **æ“ä½œ**ï¼š`offer()` æ·»åŠ ï¼Œ`take()` å–å‡º

#### ç¬¬ä¸‰å±‚ï¼šæ¶ˆè´¹è€…ï¼ˆå•ä¸€å‘é€çº¿ç¨‹ï¼‰
- **èŒè´£**ï¼šä»é˜Ÿåˆ—å–å‘½ä»¤ï¼Œæ‰§è¡Œå‘é€åè®®
- **ç‰¹ç‚¹**ï¼šå•çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œ
- **æ“ä½œ**ï¼š`serialPortManager.sendToRS485WithProtocol()`

## ğŸ”„ å·¥ä½œæµç¨‹

### è¯¦ç»†æ­¥éª¤

1. **åˆå§‹åŒ–é˜¶æ®µ**
   ```java
   // Activityåˆ›å»ºæ—¶
   sendQueueManager = new SendQueueManager(serialPortManager);
   sendQueueManager.start();  // å¯åŠ¨å‘é€çº¿ç¨‹
   ```

2. **å¼€å…³å¼€å¯**
   ```java
   // ç”¨æˆ·ç‚¹å‡»"ADDR1-3"æŒ‰é’®
   startGroup(0);  // å¯åŠ¨å¼€å…³1çš„çº¿ç¨‹
   ```

3. **æ·»åŠ å‘½ä»¤**
   ```java
   // å¼€å…³1çº¿ç¨‹å¾ªç¯æ‰§è¡Œ
   while (groupStates.get(0)) {
       for (int i = 0; i <= 2; i++) {  // ADDR1, ADDR2, ADDR3
           addCommandToQueue(0, i);  // æ·»åŠ åˆ°é˜Ÿåˆ—
           Thread.sleep(1);
       }
   }
   ```

4. **é˜Ÿåˆ—ç¼“å­˜**
   ```
   [é˜Ÿåˆ—çŠ¶æ€]
   [ADDR1 from Group0]
   [ADDR2 from Group0]
   [ADDR7 from Group1]  â† å¦‚æœå¼€å…³2ä¹Ÿåœ¨è¿è¡Œ
   [ADDR3 from Group0]
   [ADDR8 from Group1]
   ...
   ```

5. **å‘é€çº¿ç¨‹å¤„ç†**
   ```java
   while (isRunning) {
       SendCommand cmd = sendQueue.take();  // é˜»å¡ç­‰å¾…
       
       // æ‰§è¡Œå®Œæ•´å‘é€åè®®
       serialPortManager.sendToRS485WithProtocol(cmd.header, cmd.data);
       
       Thread.sleep(1);  // çŸ­æš‚å»¶è¿Ÿ
   }
   ```

6. **åè®®æ‰§è¡Œ**ï¼ˆsynchronizedä¿æŠ¤ï¼‰
   ```
   1. åˆ‡æ¢åˆ°363636æ³¢ç‰¹ç‡(æ— æ ¡éªŒ)
   2. å‘é€0x00 breakä¿¡å·
   3. åˆ‡æ¢åˆ°500000æ³¢ç‰¹ç‡(å¶æ ¡éªŒ)
   4. å‘é€header
   5. ç­‰å¾…ä»æœºå›å¤0xFC
   6. å‘é€data
   ```

## ğŸ“Š è½®æµå‘é€ç¤ºä¾‹

### åœºæ™¯1ï¼šå•å¼€å…³è¿è¡Œ

**å¼€å…³1 (ADDR1-3)** å¼€å¯

```
æ—¶é—´çº¿:
T1: [ADDR1] â”€â”€â†’ é˜Ÿåˆ— â”€â”€â†’ å‘é€
T2: [ADDR2] â”€â”€â†’ é˜Ÿåˆ— â”€â”€â†’ å‘é€
T3: [ADDR3] â”€â”€â†’ é˜Ÿåˆ— â”€â”€â†’ å‘é€
T4: [ADDR1] â”€â”€â†’ é˜Ÿåˆ— â”€â”€â†’ å‘é€
...

å‘é€é¡ºåº: ADDR1 â†’ ADDR2 â†’ ADDR3 â†’ ADDR1 â†’ ADDR2 â†’ ...
```

### åœºæ™¯2ï¼šåŒå¼€å…³è¿è¡Œï¼ˆè½®æµï¼ï¼‰

**å¼€å…³1 (ADDR1-3)** å’Œ **å¼€å…³2 (ADDR7-9)** åŒæ—¶å¼€å¯

```
æ—¶é—´çº¿:
T1: å¼€å…³1æ·»åŠ [ADDR1] â”€â”€â”
T2: å¼€å…³2æ·»åŠ [ADDR7] â”€â”€â”¼â”€â”€â†’ é˜Ÿåˆ—: [ADDR1][ADDR7]
T3: å¼€å…³1æ·»åŠ [ADDR2] â”€â”€â”¤
T4: å¼€å…³2æ·»åŠ [ADDR8] â”€â”€â”¼â”€â”€â†’ é˜Ÿåˆ—: [ADDR1][ADDR7][ADDR2][ADDR8]
T5: å¼€å…³1æ·»åŠ [ADDR3] â”€â”€â”¤
T6: å¼€å…³2æ·»åŠ [ADDR9] â”€â”€â”¼â”€â”€â†’ é˜Ÿåˆ—: [ADDR1][ADDR7][ADDR2][ADDR8][ADDR3][ADDR9]
...

å‘é€çº¿ç¨‹å¤„ç†:
å‘é€ ADDR1 (å¼€å…³1)
å‘é€ ADDR7 (å¼€å…³2)  â† è½®æµï¼
å‘é€ ADDR2 (å¼€å…³1)
å‘é€ ADDR8 (å¼€å…³2)  â† è½®æµï¼
å‘é€ ADDR3 (å¼€å…³1)
å‘é€ ADDR9 (å¼€å…³2)  â† è½®æµï¼
...
```

### åœºæ™¯3ï¼šä¸‰å¼€å…³è¿è¡Œ

**å¼€å…³1ã€2ã€3** åŒæ—¶å¼€å¯

```
é˜Ÿåˆ—çŠ¶æ€ï¼ˆåŠ¨æ€ï¼‰:
[ADDR1-å¼€å…³1] [ADDR7-å¼€å…³2] [ADDR13-å¼€å…³3] 
[ADDR2-å¼€å…³1] [ADDR8-å¼€å…³2] [ADDR14-å¼€å…³3]
[ADDR3-å¼€å…³1] [ADDR9-å¼€å…³2] [ADDR15-å¼€å…³3]
...

å‘é€é¡ºåº:
ADDR1 â†’ ADDR7 â†’ ADDR13 â†’ ADDR2 â†’ ADDR8 â†’ ADDR14 â†’ ADDR3 â†’ ADDR9 â†’ ADDR15 â†’ ...
 (1)     (2)     (3)      (1)     (2)     (3)      (1)     (2)     (3)

å®Œç¾çš„ä¸‰è·¯è½®æµï¼
```

## âš™ï¸ æ ¸å¿ƒä»£ç 

### SendQueueManager.java

```java
public class SendQueueManager {
    private BlockingQueue<SendCommand> sendQueue;
    private Thread sendThread;
    private volatile boolean isRunning = false;
    
    public void start() {
        isRunning = true;
        sendThread = new Thread(() -> {
            while (isRunning) {
                try {
                    // é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰å‘½ä»¤
                    SendCommand cmd = sendQueue.take();
                    
                    // å‘é€å‘½ä»¤ï¼ˆsynchronizedä¿æŠ¤ï¼‰
                    serialPortManager.sendToRS485WithProtocol(cmd.header, cmd.data);
                    
                    // çŸ­æš‚å»¶è¿Ÿ
                    Thread.sleep(1);
                } catch (InterruptedException e) {
                    break;
                }
            }
        }, "SendQueueThread");
        sendThread.start();
    }
    
    public boolean addCommand(int groupId, byte[] header, byte[] data) {
        SendCommand cmd = new SendCommand(groupId, header, data);
        return sendQueue.offer(cmd);  // éé˜»å¡æ·»åŠ 
    }
}
```

### SwitchControlActivity.java

```java
private void startGroup(int groupIndex) {
    // ... UIæ›´æ–° ...
    
    Thread thread = new Thread(() -> {
        while (groupStates.get(groupIndex)) {
            for (int i = group.startIndex; i <= group.endIndex; i++) {
                // å…³é”®ï¼šæ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä¸ç›´æ¥å‘é€
                addCommandToQueue(groupIndex, i);
                Thread.sleep(1);
            }
        }
    }, "Group-" + groupIndex);
    
    thread.start();
}

private boolean addCommandToQueue(int groupId, int cmdIndex) {
    // å‡†å¤‡å‘½ä»¤æ•°æ®
    byte[] header = ...;
    byte[] data = ...;
    
    // æ·»åŠ åˆ°é˜Ÿåˆ—
    return sendQueueManager.addCommand(groupId, header, data);
}
```

## ğŸ”’ çº¿ç¨‹å®‰å…¨

### ä¸‰é‡ä¿æŠ¤

1. **BlockingQueue**
   - Javaå¹¶å‘åŒ…æä¾›çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
   - è‡ªåŠ¨å¤„ç†å¹¶å‘æ·»åŠ å’Œå–å‡º
   - æ— éœ€é¢å¤–åŒæ­¥

2. **synchronized**
   - ä¿æŠ¤å‘é€åè®®çš„å®Œæ•´æ€§
   - ç¡®ä¿æ³¢ç‰¹ç‡åˆ‡æ¢ä¸è¢«æ‰“æ–­
   - ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªå‘½ä»¤

3. **volatile**
   - `isRunning` æ ‡å¿—ä½¿ç”¨volatile
   - ç¡®ä¿è·¨çº¿ç¨‹å¯è§æ€§
   - åŠæ—¶å“åº”åœæ­¢å‘½ä»¤

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### ååé‡

**å•å¼€å…³è¿è¡Œ**:
- é˜Ÿåˆ—å¼€é”€ï¼š<1ms
- å‘é€æ—¶é—´ï¼šçº¦15ms/æ¡
- ç†è®ºé€Ÿåº¦ï¼š~66æ¡/ç§’

**åŒå¼€å…³è¿è¡Œ**:
- ä¸¤ä¸ªå¼€å…³è½®æµæ·»åŠ å‘½ä»¤
- å‘é€çº¿ç¨‹ä¸²è¡Œå¤„ç†
- ç†è®ºé€Ÿåº¦ï¼š~66æ¡/ç§’ï¼ˆæ€»å’Œï¼‰
- æ¯ä¸ªå¼€å…³ï¼š~33æ¡/ç§’

**ä¸‰å¼€å…³è¿è¡Œ**:
- ä¸‰ä¸ªå¼€å…³è½®æµæ·»åŠ å‘½ä»¤
- ç†è®ºé€Ÿåº¦ï¼š~66æ¡/ç§’ï¼ˆæ€»å’Œï¼‰
- æ¯ä¸ªå¼€å…³ï¼š~22æ¡/ç§’

### å»¶è¿Ÿ

- **æ·»åŠ å»¶è¿Ÿ**ï¼š<1msï¼ˆå‡ ä¹ç«‹å³ï¼‰
- **æ’é˜Ÿå»¶è¿Ÿ**ï¼šå–å†³äºé˜Ÿåˆ—é•¿åº¦
  - é˜Ÿåˆ—ä¸ºç©ºï¼šç«‹å³å‘é€
  - é˜Ÿåˆ—æœ‰Næ¡ï¼šç­‰å¾…NÃ—15ms
- **å‘é€å»¶è¿Ÿ**ï¼š15msï¼ˆå›ºå®šï¼‰

### å…¬å¹³æ€§

âœ… **å®Œå…¨å…¬å¹³**ï¼šFIFOé˜Ÿåˆ—ä¿è¯æŒ‰æ·»åŠ é¡ºåºå‘é€
âœ… **æ— é¥¥é¥¿**ï¼šæ‰€æœ‰å¼€å…³éƒ½èƒ½å‡åŒ€è·å¾—å‘é€æœºä¼š
âœ… **å¯é¢„æµ‹**ï¼šå‘é€é¡ºåºå®Œå…¨å¯é¢„æµ‹

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | è¯´æ˜ | æ•ˆæœ |
|-----|------|------|
| **è½®æµå‘é€** | FIFOé˜Ÿåˆ—è‡ªåŠ¨å®ç° | âœ… å¤šå¼€å…³äº¤æ›¿å‘é€ |
| **å…¬å¹³è°ƒåº¦** | æŒ‰æ—¶é—´é¡ºåºå¤„ç† | âœ… æ— ä¼˜å…ˆçº§å·®å¼‚ |
| **çº¿ç¨‹å®‰å…¨** | BlockingQueue + synchronized | âœ… æ— ç«æ€æ¡ä»¶ |
| **åè®®å®Œæ•´** | æ•´ä¸ªåè®®åœ¨synchronizedå†… | âœ… æ³¢ç‰¹ç‡åˆ‡æ¢æ­£ç¡® |
| **æ˜“äºæ‰©å±•** | é˜Ÿåˆ—æ¨¡å¼è§£è€¦ | âœ… å¯å¢åŠ å¼€å…³æ•°é‡ |
| **èµ„æºå‹å¥½** | å•ä¸€å‘é€çº¿ç¨‹ | âœ… ä½CPUå ç”¨ |

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€

åœ¨ `SendQueueManager` ä¸­æ·»åŠ æ—¥å¿—ï¼š

```java
public boolean addCommand(int groupId, byte[] header, byte[] data) {
    SendCommand cmd = new SendCommand(groupId, header, data);
    boolean success = sendQueue.offer(cmd);
    
    // è°ƒè¯•æ—¥å¿—
    Log.d(TAG, String.format("æ·»åŠ å‘½ä»¤ Group%d, é˜Ÿåˆ—å¤§å°: %d", 
        groupId, sendQueue.size()));
    
    return success;
}
```

### è§‚å¯Ÿå‘é€é¡ºåº

åœ¨å‘é€çº¿ç¨‹ä¸­æ·»åŠ æ—¥å¿—ï¼š

```java
while (isRunning) {
    SendCommand cmd = sendQueue.take();
    
    // è®°å½•å‘é€é¡ºåº
    Log.i(TAG, "å‘é€å‘½ä»¤ from Group" + cmd.groupId);
    
    serialPortManager.sendToRS485WithProtocol(cmd.header, cmd.data);
}
```

é¢„æœŸè¾“å‡ºï¼ˆåŒå¼€å…³ï¼‰ï¼š
```
å‘é€å‘½ä»¤ from Group0  â† ADDR1
å‘é€å‘½ä»¤ from Group1  â† ADDR7
å‘é€å‘½ä»¤ from Group0  â† ADDR2
å‘é€å‘½ä»¤ from Group1  â† ADDR8
å‘é€å‘½ä»¤ from Group0  â† ADDR3
å‘é€å‘½ä»¤ from Group1  â† ADDR9
...
```

## ğŸ“š æ€»ç»“

è½®æµå‘é€æœºåˆ¶é€šè¿‡**ç”Ÿäº§è€…-é˜Ÿåˆ—-æ¶ˆè´¹è€…**æ¨¡å¼ï¼Œä¼˜é›…åœ°è§£å†³äº†å¤šå¼€å…³å¹¶å‘å‘é€çš„é—®é¢˜ï¼š

- ğŸ¯ **ç”¨æˆ·ä½“éªŒ**ï¼šå¤šå¼€å…³çœŸæ­£è½®æµå‘é€
- ğŸ”’ **æ•°æ®å®‰å…¨**ï¼šæ— æ··ä¹±ï¼Œåè®®å®Œæ•´
- âš–ï¸ **å…¬å¹³è°ƒåº¦**ï¼šFIFOä¿è¯å…¬å¹³
- ğŸš€ **æ€§èƒ½è‰¯å¥½**ï¼šå•çº¿ç¨‹ä¸²è¡Œå¤„ç†ï¼Œé«˜æ•ˆç¨³å®š

---

**ç‰ˆæœ¬**: v2.0  
**æ—¥æœŸ**: 2025-01-03  
**ä½œè€…**: AI Assistant

